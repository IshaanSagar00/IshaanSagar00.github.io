<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Monthly EMI Breakdown (Running Loan)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{font-family:Arial,sans-serif;background:#f6f7fb;padding:20px}
.card{max-width:1100px;margin:auto;background:#fff;padding:25px;border-radius:10px;box-shadow:0 10px 25px rgba(0,0,0,.08)}
h1{text-align:center}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:15px}
label{font-weight:bold;font-size:14px}
input,select{width:100%;padding:10px;margin-top:6px;font-size:14px}
button{margin-top:15px;padding:12px;font-size:16px;background:#2563eb;color:#fff;border:none;border-radius:6px;cursor:pointer}
.box{margin-top:20px;padding:16px;border:1px solid #ddd;border-radius:8px}
.hidden{display:none !important}
table{width:100%;border-collapse:collapse;margin-top:25px;font-size:14px}
th,td{border:1px solid #ddd;padding:8px;text-align:right}
th{background:#f1f5f9}
th:first-child,td:first-child{text-align:left}
tr.current{background:#e0f2fe;font-weight:bold}
.note{margin-top:15px;font-size:13px;color:#555;background:#fafafa;padding:10px;border-radius:6px}
</style>
</head>

<body>
<div class="card">
<h1>Monthly EMI Breakdown (Running Loan)</h1>

<div class="grid">
  <div>
    <label>Loan Amount (₹)</label>
    <input id="loan" placeholder="e.g 10,00,000">
  </div>

  <div>
    <label>Interest Rate (% per year)</label>
    <input type="number" id="rate" placeholder="e.g 14">
  </div>

  <div>
    <label>Loan Tenure</label>
    <div style="display:flex;gap:6px">
      <input type="number" id="tenure" placeholder="e.g 5">
      <select id="tenureType">
        <option value="years">Years</option>
        <option value="months">Months</option>
      </select>
    </div>
  </div>

  <div>
    <label>EMI Start Month</label>
    <div style="display:flex;gap:6px">
      <select id="startMonth"></select>
      <select id="startYear"></select>
    </div>
  </div>
</div>

<div class="box">
<b>Advanced Options</b>

<label>Strategy</label>
<select id="strategy">
  <option value="none">None</option>
  <option value="emi">EMI Increase</option>
  <option value="lump">Lump Sum</option>
</select>

<div id="emiBox" class="hidden">
  <label>Increase Type</label>
  <select id="emiType">
    <option value="percent">Percentage (%)</option>
    <option value="amount">Fixed Amount (₹)</option>
  </select>

  <label>Increase Value</label>
  <input type="number" id="emiValue" value="10">

  <label>Frequency</label>
  <select id="emiFreq">
    <option value="once">One-time</option>
    <option value="3">Every 3 months</option>
    <option value="6">Every 6 months</option>
    <option value="12">Every 12 months</option>
  </select>

  <label>Start Increase</label>
  <select id="emiStartType">
    <option value="current">From Current Month</option>
    <option value="custom">From Custom Month</option>
  </select>

  <!-- CUSTOM DATE (HIDDEN BY DEFAULT) -->
  <div id="emiCustomDate" class="hidden" style="display:flex;gap:6px">
    <select id="emiStartMonth"></select>
    <select id="emiStartYear"></select>
  </div>
</div>

<div id="lumpBox" class="hidden">
  <label>Lump Sum Amount (₹)</label>
  <input type="number" id="lumpAmount">

  <label>Frequency</label>
  <select id="lumpFreq">
    <option value="once">One-time</option>
    <option value="3">Every 3 months</option>
    <option value="6">Every 6 months</option>
    <option value="12">Every 12 months</option>
  </select>
</div>
</div>

<button onclick="generate()">Generate Breakdown</button>

<div id="summary" class="box hidden"></div>
<div id="table"></div>

<div class="note">
Disclaimer: This is an approximate illustration. Actual lender calculations may vary.
</div>
</div>

<script>
const months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

// Populate months + years
function fillMonthYear(m,y){
  m.innerHTML=months.map((x,i)=>`<option value="${i}">${x}</option>`).join("");
  y.innerHTML="";
  for(let i=1990;i<=2050;i++){
    y.innerHTML+=`<option ${i===2025?"selected":""}>${i}</option>`;
  }
}

fillMonthYear(startMonth,startYear);
fillMonthYear(emiStartMonth,emiStartYear);

// Indian number formatting
loan.oninput=e=>{
  let v=e.target.value.replace(/,/g,"").replace(/\D/g,"");
  if(!v){e.target.value="";return}
  let r=v.slice(-3),l=v.slice(0,-3);
  e.target.value=l.replace(/\B(?=(\d{2})+(?!\d))/g,",")+(l?","+r:r);
};

// Strategy toggle
strategy.onchange=()=>{
  emiBox.classList.toggle("hidden",strategy.value!=="emi");
  lumpBox.classList.toggle("hidden",strategy.value!=="lump");
};

// ✅ FINAL FIX — calendar logic
emiStartType.onchange=()=>{
  if(emiStartType.value==="custom"){
    emiCustomDate.classList.remove("hidden");
  }else{
    emiCustomDate.classList.add("hidden");
  }
};

// Force correct state on load
emiCustomDate.classList.add("hidden");

function inr(n){return n.toLocaleString("en-IN")}

function generate(){
  let P=+loan.value.replace(/,/g,"");
  let r=+rate.value/12/100;
  let t=+tenure.value;
  let N=tenureType.value==="years"?t*12:t;
  if(!P||!r||!N){alert("Fill all fields");return}

  let EMI=P*r*Math.pow(1+r,N)/(Math.pow(1+r,N)-1);
  let bal=P,balA=P,baseI=0,advI=0,curEMI=EMI;
  let date=new Date(startYear.value,startMonth.value,1);
  let today=new Date();
  let currentKey=today.getFullYear()*12+today.getMonth();

  let emiStartKey=currentKey;
  if(emiStartType.value==="custom"){
    emiStartKey=emiStartYear.value*12+Number(emiStartMonth.value);
  }

  let html=`<table><tr>
  <th>Month</th><th>EMI</th><th>Interest</th><th>Principal</th><th>Extra Payment</th><th>Balance</th>
  </tr>`;

  let advEnd=0;

  for(let m=1;m<=N;m++){
    let key=date.getFullYear()*12+date.getMonth();
    let i=bal*r;baseI+=i;bal-=EMI-i;

    let extra=0;
    if(strategy.value==="emi"&&emiValue.value&&key>=emiStartKey){
      if(emiFreq.value==="once"&&key===emiStartKey||
         emiFreq.value!=="once"&&(key-emiStartKey)%emiFreq.value===0){
        curEMI=emiType.value==="percent"?curEMI*(1+emiValue.value/100):curEMI+Number(emiValue.value);
      }
    }

    if(strategy.value==="lump"&&lumpAmount.value){
      if(lumpFreq.value==="once"&&m===1||
         lumpFreq.value!=="once"&&m%lumpFreq.value===0){
        extra=Math.min(+lumpAmount.value,balA);
        balA-=extra;
      }
    }

    let ai=balA*r;advI+=ai;
    let p=Math.min(curEMI-ai,balA);balA-=p;
    if(balA<=0&&!advEnd)advEnd=m;

    html+=`<tr class="${date.getMonth()===today.getMonth()&&date.getFullYear()===today.getFullYear()?'current':''}">
<td>${months[date.getMonth()]} ${date.getFullYear()}</td>
<td>₹${inr(Math.round(p+ai))}</td>
<td>₹${inr(Math.round(ai))}</td>
<td>₹${inr(Math.round(p))}</td>
<td>${extra?`₹${inr(extra)}`:"—"}</td>
<td>₹${inr(Math.max(0,Math.round(balA)))}</td>
</tr>`;

    date.setMonth(date.getMonth()+1);
  }

  table.innerHTML=html+"</table>";
  summary.innerHTML=`<h3>Comparison Summary</h3>
  <p><b>Remaining Tenure:</b> ${N} → ${advEnd} months (${N-advEnd} months saved)</p>
  <p><b>Interest Saved:</b> ₹${inr(Math.round(baseI-advI))}</p>`;
  summary.classList.remove("hidden");
}
</script>
</body>
</html>
